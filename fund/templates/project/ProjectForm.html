{% extends "base.html" %}
{% load static %}
{% block title %}Project Management{% endblock title %}

{% block content %}
<div class="py-5">
  <!-- Header and Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Project Management</h2>
    <!-- Button to trigger Add Project Modal -->
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
      Add Project
    </button>
  </div>

  <!-- Projects displayed as cards -->
  <div class="row">
    {% for project in projects %}
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ project.title }}</h5>
          <p class="card-text">{{ project.details|default:"No details provided." }}</p>
          <p class="card-text">
            <small class="text-muted">Category: {{ project.category }}</small><br>
            <small class="text-muted">Start: {{ project.start_time|date:"M d, Y" }}</small><br>
            <small class="text-muted">End: {{ project.end_time|date:"M d, Y" }}</small>
          </p>
          <!-- Edit button with data attributes for modal population -->
          <button class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#updateProjectModal"
                  data-id="{{ project.id }}"
                  data-title="{{ project.title }}"
                  data-details="{{ project.details }}"
                  data-total_target="{{ project.total_target }}"
                  data-start_time="{{ project.start_time|date:'Y-m-d\\TH:i' }}"
                  data-end_time="{{ project.end_time|date:'Y-m-d\\TH:i' }}"
                  data-category="{{ project.category.id }}"
                  data-tags="{% for tag in project.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            Edit
          </button>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info">No projects available.</div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'project_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Add Project Form Fields -->
          <div class="mb-3">
            <label for="addTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="addTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="addDetails" class="form-label">Details</label>
            <textarea class="form-control" id="addDetails" name="details"></textarea>
          </div>
          <div class="mb-3">
            <label for="addTotalTarget" class="form-label">Total Target</label>
            <input type="number" step="0.01" class="form-control" id="addTotalTarget" name="total_target" required>
          </div>
          <div class="mb-3">
            <label for="addStartTime" class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" id="addStartTime" name="start_time" required>
          </div>
          <div class="mb-3">
            <label for="addEndTime" class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" id="addEndTime" name="end_time" required>
          </div>
          <div class="mb-3">
            <label for="addCategory" class="form-label">Category</label>
            <select class="form-select" id="addCategory" name="category" required>
              <option value="">Select a Category</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="addTags" class="form-label">Tags</label>
            <select class="form-select" id="addTags" name="tags" multiple>
              {% for tag in tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Project</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Project Modal -->
<div class="modal fade" id="updateProjectModal" tabindex="-1" aria-labelledby="updateProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="updateProjectForm" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="updateProjectModalLabel">Update Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Hidden field to store project ID -->
          <input type="hidden" id="updateProjectId" name="project_id">
          <div class="mb-3">
            <label for="updateTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="updateTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="updateDetails" class="form-label">Details</label>
            <textarea class="form-control" id="updateDetails" name="details"></textarea>
          </div>
          <div class="mb-3">
            <label for="updateTotalTarget" class="form-label">Total Target</label>
            <input type="number" step="0.01" class="form-control" id="updateTotalTarget" name="total_target" required>
          </div>
          <div class="mb-3">
            <label for="updateStartTime" class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" id="updateStartTime" name="start_time" required>
          </div>
          <div class="mb-3">
            <label for="updateEndTime" class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" id="updateEndTime" name="end_time" required>
          </div>
          <div class="mb-3">
            <label for="updateCategory" class="form-label">Category</label>
            <select class="form-select" id="updateCategory" name="category" required>
              <option value="">Select a Category</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="updateTags" class="form-label">Tags</label>
            <select class="form-select" id="updateTags" name="tags" multiple>
              {% for tag in tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <!-- Delete button inside update modal -->
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            Delete
          </button>
          <!-- Update button remains disabled until changes are detected -->
          <button type="submit" class="btn btn-primary" id="updateSubmitBtn" disabled>
            Update Project
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="deleteProjectForm" action="{% url 'project_delete' 0 %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this project?
          <!-- Hidden field to pass the project ID -->
          <input type="hidden" id="deleteProjectId" name="project_id">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript to handle modal data and form changes -->
<script>
  let initialUpdateData = {};

  // When the update modal is shown, populate the form with project data
  const updateModal = document.getElementById('updateProjectModal');
  updateModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const projectId = button.getAttribute('data-id');
    const title = button.getAttribute('data-title');
    const details = button.getAttribute('data-details');
    const totalTarget = button.getAttribute('data-total_target');
    const startTime = button.getAttribute('data-start_time');
    const endTime = button.getAttribute('data-end_time');
    const category = button.getAttribute('data-category');
    // Convert comma-separated tags string to an array
    const tags = button.getAttribute('data-tags').split(',');

    // Populate the update form fields
    document.getElementById('updateProjectId').value = projectId;
    document.getElementById('updateTitle').value = title;
    document.getElementById('updateDetails').value = details;
    document.getElementById('updateTotalTarget').value = totalTarget;
    document.getElementById('updateStartTime').value = startTime;
    document.getElementById('updateEndTime').value = endTime;
    document.getElementById('updateCategory').value = category;
    
    // Set selected options for tags
    const updateTagsSelect = document.getElementById('updateTags');
    for (let option of updateTagsSelect.options) {
      option.selected = tags.includes(option.value);
    }
    
    // Save initial data for change detection
    initialUpdateData = {
      title: title,
      details: details,
      total_target: totalTarget,
      start_time: startTime,
      end_time: endTime,
      category: category,
      tags: tags.join(',')
    };

    // Set the form action URL for updating the project
    document.getElementById('updateProjectForm').action = "{% url 'project_update' 0 %}".replace("0", projectId);

    // Disable the update button initially
    document.getElementById('updateSubmitBtn').disabled = true;
  });

  // Listen for changes in the update form to enable the update button
  const updateForm = document.getElementById('updateProjectForm');
  updateForm.addEventListener('input', () => {
    const currentData = {
      title: document.getElementById('updateTitle').value,
      details: document.getElementById('updateDetails').value,
      total_target: document.getElementById('updateTotalTarget').value,
      start_time: document.getElementById('updateStartTime').value,
      end_time: document.getElementById('updateEndTime').value,
      category: document.getElementById('updateCategory').value,
      tags: Array.from(document.getElementById('updateTags').selectedOptions).map(opt => opt.value).join(',')
    };

    const hasChanged = Object.keys(initialUpdateData).some(key => initialUpdateData[key] !== currentData[key]);
    document.getElementById('updateSubmitBtn').disabled = !hasChanged;
  });

  // When delete confirmation modal is shown, set the project ID for deletion
  const deleteConfirmModal = document.getElementById('deleteConfirmModal');
  deleteConfirmModal.addEventListener('show.bs.modal', event => {
    const projectId = document.getElementById('updateProjectId').value;
    document.getElementById('deleteProjectId').value = projectId;
    document.getElementById('deleteProjectForm').action = "{% url 'project_delete' 0 %}".replace("0", projectId);
  });
</script>
{% endblock %}
