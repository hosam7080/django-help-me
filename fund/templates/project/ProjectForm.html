{% extends "base/base.html" %}
{% load static %}
{% block title %}Project Management{% endblock title %}

{% block content %}
<div class="py-5">
  <!-- Header section with title and button to open the Add Project modal -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Project Management</h2>
    <!-- Button to trigger the Add Project Modal -->
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
      Add Project
    </button>
  </div>

  <!-- Container for displaying all projects as individual cards -->
  <div class="container">
    {% for project in projects %}
    <!-- Each project is displayed in a card format -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">
              <a class="text-decoration-none text-info" href="{% url 'project_detail' project.id %}">
                {{ project.title}} </a>
            </h5>
            <p class="card-text">{{ project.details|default:"No details provided." }}</p>
            <p class="card-text">
              <small class="text-muted">Category: {{ project.category }}</small><br>
              <small class="text-muted">Start: {{ project.start_time|date:"M d, Y" }}</small><br>
              <small class="text-muted">End: {{ project.end_time|date:"M d, Y" }}</small>
            </p>
            <!-- Edit button with data attributes for populating the Update Project modal -->
            <button class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#updateProjectModal"
              data-id="{{ project.id }}" data-title="{{ project.title }}" data-details="{{ project.details }}"
              data-total_target="{{ project.total_target }}"
              data-start_time="{{ project.start_time|date:'Y-m-d\\TH:i' }}"
              data-end_time="{{ project.end_time|date:'Y-m-d\\TH:i' }}" data-category="{{ project.category.id }}"
              data-tags="{% for tag in project.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
              Edit Your Project
            </button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <!-- Message displayed when there are no projects -->
    <div class="alert alert-info">No projects available.</div>
    {% endfor %}
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Form with Bootstrap validation for adding a new project -->
      <form method="POST" action="{% url 'project_create' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Input field for project title -->
          <div class="mb-3">
            <label for="addTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="addTitle" name="title" required>
            <div class="invalid-feedback">
              Please provide a project title.
            </div>
          </div>
          <!-- Textarea for project details -->
          <div class="mb-3">
            <label for="addDetails" class="form-label">Details</label>
            <textarea class="form-control" id="addDetails" name="details" required></textarea>
            <div class="invalid-feedback">
              Please provide project details.
            </div>
          </div>
          <!-- Input field for project total target -->
          <div class="mb-3">
            <label for="addTotalTarget" class="form-label">Total Target</label>
            <input type="number" step="0.01" class="form-control" id="addTotalTarget" name="total_target" required>
            <div class="invalid-feedback">
              Please enter a valid total target.
            </div>
          </div>
          <!-- Input field for project start time -->
          <div class="mb-3">
            <label for="addStartTime" class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" id="addStartTime" name="start_time" required>
            <div class="invalid-feedback">
              Please provide a start time.
            </div>
          </div>
          <!-- Input field for project end time -->
          <div class="mb-3">
            <label for="addEndTime" class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" id="addEndTime" name="end_time" required>
            <div class="invalid-feedback">
              Please provide an end time.
            </div>
          </div>
          <!-- Dropdown for selecting project category -->
          <div class="mb-3">
            <label for="addCategory" class="form-label">Category</label>
            <select class="form-select" id="addCategory" name="category" required>
              <option value="">Select a Category</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">
              Please select a category.
            </div>
          </div>

          <!-- Custom Tags selection block with dropdown and add button for Add Modal -->
          <div class="mb-3">
            <label class="form-label">Tags</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false" id="addTagDropdownButton">Select Tag</button>
              <ul class="dropdown-menu" id="addTagDropdownMenu">
                {% for tag in tags %}
                <li><a class="dropdown-item" href="#" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">{{
                    tag.name }}</a></li>
                {% endfor %}
              </ul>
              <button class="btn btn-secondary" type="button" id="addTagButton">Add</button>
            </div>
            <input type="hidden" name="tags" id="addSelectedTagsInput" required>
            <div id="addSelectedTagsContainer" class="mt-2"></div>
            <div class="invalid-feedback">
              Please select at least one tag.
            </div>
          </div>
          <!-- End of Tags selection block -->

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Project</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Project Modal -->
<div class="modal fade" id="updateProjectModal" tabindex="-1" aria-labelledby="updateProjectModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Form with Bootstrap validation for updating a project -->
      <form method="POST" id="updateProjectForm" action="" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="updateProjectModalLabel">Update Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Hidden input to store the project ID for update -->
          <input type="hidden" id="updateProjectId" name="project_id">
          <!-- Input field for project title in update form -->
          <div class="mb-3">
            <label for="updateTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="updateTitle" name="title" required>
            <div class="invalid-feedback">
              Please provide a project title.
            </div>
          </div>
          <!-- Textarea for project details in update form -->
          <div class="mb-3">
            <label for="updateDetails" class="form-label">Details</label>
            <textarea class="form-control" id="updateDetails" name="details" required></textarea>
            <div class="invalid-feedback">
              Please provide project details.
            </div>
          </div>
          <!-- Input field for project total target in update form -->
          <div class="mb-3">
            <label for="updateTotalTarget" class="form-label">Total Target</label>
            <input type="number" step="0.01" class="form-control" id="updateTotalTarget" name="total_target" required>
            <div class="invalid-feedback">
              Please enter a valid total target.
            </div>
          </div>
          <!-- Input field for project start time in update form -->
          <div class="mb-3">
            <label for="updateStartTime" class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" id="updateStartTime" name="start_time" required>
            <div class="invalid-feedback">
              Please provide a start time.
            </div>
          </div>
          <!-- Input field for project end time in update form -->
          <div class="mb-3">
            <label for="updateEndTime" class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" id="updateEndTime" name="end_time" required>
            <div class="invalid-feedback">
              Please provide an end time.
            </div>
          </div>
          <!-- Dropdown for selecting project category in update form -->
          <div class="mb-3">
            <label for="updateCategory" class="form-label">Category</label>
            <select class="form-select" id="updateCategory" name="category" required>
              <option value="">Select a Category</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">
              Please select a category.
            </div>
          </div>

          <!-- Custom Tags selection block with dropdown and add button for Update Modal -->
          <div class="mb-3">
            <label class="form-label">Tags</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false" id="updateTagDropdownButton">Select Tag</button>
              <ul class="dropdown-menu" id="updateTagDropdownMenu">
                {% for tag in tags %}
                <li><a class="dropdown-item" href="#" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">{{
                    tag.name }}</a></li>
                {% endfor %}
              </ul>
              <button class="btn btn-secondary" type="button" id="updateTagButton">Add</button>
            </div>
            <input type="hidden" name="tags" id="updateSelectedTagsInput" required>
            <div id="updateSelectedTagsContainer" class="mt-2"></div>
            <div class="invalid-feedback">
              Please select at least one tag.
            </div>
          </div>
          <!-- End of Tags selection block for Update Modal -->

        </div>
        <div class="modal-footer">
          <!-- Button to open the Delete Confirmation modal -->
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            Delete
          </button>
          <!-- Submit button for updating the project, disabled until a change is detected -->
          <button type="submit" class="btn btn-primary" id="updateSubmitBtn" disabled>
            Update Project
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="deleteProjectForm" action="{% url 'project_delete' 0 %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this project?
          <input type="hidden" id="deleteProjectId" name="project_id">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript to handle modals, form validations, and tags management -->
<script>
  // Bootstrap form validation script
  (function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }
          form.classList.add('was-validated')
        }, false)
      })
  })();

  let initialUpdateData = {};

  // Function to check for changes in the update form
  function checkUpdateChanges() {
    const currentData = {
      title: document.getElementById('updateTitle').value,
      details: document.getElementById('updateDetails').value,
      total_target: document.getElementById('updateTotalTarget').value,
      start_time: document.getElementById('updateStartTime').value,
      end_time: document.getElementById('updateEndTime').value,
      category: document.getElementById('updateCategory').value,
      tags: Array.from(document.getElementById('updateSelectedTagsContainer').querySelectorAll('span'))
        .map(opt => opt.getAttribute('data-tag-id')).join(',')
    };
    const hasChanged = Object.keys(initialUpdateData).some(key => initialUpdateData[key] !== currentData[key]);
    document.getElementById('updateSubmitBtn').disabled = !hasChanged;
  }

  // Populate the update modal with the selected project's data
  const updateModal = document.getElementById('updateProjectModal');
  updateModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const projectId = button.getAttribute('data-id');
    const title = button.getAttribute('data-title');
    const details = button.getAttribute('data-details');
    const totalTarget = button.getAttribute('data-total_target');
    const startTime = button.getAttribute('data-start_time');
    const endTime = button.getAttribute('data-end_time');
    const category = button.getAttribute('data-category');
    const tags = button.getAttribute('data-tags').split(',');

    document.getElementById('updateProjectId').value = projectId;
    document.getElementById('updateTitle').value = title;
    document.getElementById('updateDetails').value = details;
    document.getElementById('updateTotalTarget').value = totalTarget;
    document.getElementById('updateStartTime').value = startTime;
    document.getElementById('updateEndTime').value = endTime;
    document.getElementById('updateCategory').value = category;

    // Setup tags in the update modal based on the project's current tags
    let container = document.getElementById('updateSelectedTagsContainer');
    container.innerHTML = '';
    tags.forEach(tagId => {
      let item = document.querySelector('#updateTagDropdownMenu a[data-tag-id="' + tagId + '"]');
      if (item) {
        let badge = document.createElement('span');
        badge.className = 'badge bg-primary me-1';
        badge.textContent = item.getAttribute('data-tag-name');
        badge.setAttribute('data-tag-id', tagId);
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function () {
          this.remove();
          updateUpdateTagsInput();
        });
        container.appendChild(badge);
      }
    });
    updateUpdateTagsInput();
    document.getElementById('updateTagDropdownButton').textContent = 'Select Tag';

    initialUpdateData = {
      title: title,
      details: details,
      total_target: totalTarget,
      start_time: startTime,
      end_time: endTime,
      category: category,
      tags: tags.join(',')
    };

    document.getElementById('updateProjectForm').action = "{% url 'project_update' 0 %}".replace("0", projectId);
    document.getElementById('updateSubmitBtn').disabled = true;
  });

  // Enable the update button when form data is changed
  const updateForm = document.getElementById('updateProjectForm');
  updateForm.addEventListener('input', checkUpdateChanges);

  // Setup the delete confirmation modal with the current project's ID
  const deleteConfirmModal = document.getElementById('deleteConfirmModal');
  deleteConfirmModal.addEventListener('show.bs.modal', event => {
    const projectId = document.getElementById('updateProjectId').value;
    document.getElementById('deleteProjectId').value = projectId;
    document.getElementById('deleteProjectForm').action = "{% url 'project_delete' 0 %}".replace("0", projectId);
  });

  /* ======== JavaScript for Tags Dropdown in Add Modal ======== */
  let addSelectedTag = null;
  document.querySelectorAll('#addTagDropdownMenu a').forEach(item => {
    item.addEventListener('click', function (e) {
      e.preventDefault();
      addSelectedTag = {
        id: this.getAttribute('data-tag-id'),
        name: this.getAttribute('data-tag-name')
      };
      document.getElementById('addTagDropdownButton').textContent = addSelectedTag.name;
    });
  });

  document.getElementById('addTagButton').addEventListener('click', function () {
    if (!addSelectedTag) return;
    let container = document.getElementById('addSelectedTagsContainer');
    if (container.querySelector('[data-tag-id="' + addSelectedTag.id + '"]')) {
      return;
    }
    let badge = document.createElement('span');
    badge.className = 'badge bg-primary me-1';
    badge.textContent = addSelectedTag.name;
    badge.setAttribute('data-tag-id', addSelectedTag.id);
    badge.style.cursor = 'pointer';
    badge.addEventListener('click', function () {
      this.remove();
      updateAddTagsInput();
    });
    container.appendChild(badge);
    updateAddTagsInput();
  });

  // Update the hidden input with the selected tags for Add Modal
  function updateAddTagsInput() {
    let tags = [];
    document.querySelectorAll('#addSelectedTagsContainer span').forEach(badge => {
      tags.push(badge.getAttribute('data-tag-id'));
    });
    document.getElementById('addSelectedTagsInput').value = tags.join(',');
  }

  /* ======== JavaScript for Tags Dropdown in Update Modal ======== */
  let updateSelectedTag = null;
  document.querySelectorAll('#updateTagDropdownMenu a').forEach(item => {
    item.addEventListener('click', function (e) {
      e.preventDefault();
      updateSelectedTag = {
        id: this.getAttribute('data-tag-id'),
        name: this.getAttribute('data-tag-name')
      };
      document.getElementById('updateTagDropdownButton').textContent = updateSelectedTag.name;
    });
  });

  document.getElementById('updateTagButton').addEventListener('click', function () {
    if (!updateSelectedTag) return;
    let container = document.getElementById('updateSelectedTagsContainer');
    if (container.querySelector('[data-tag-id="' + updateSelectedTag.id + '"]')) {
      return;
    }
    let badge = document.createElement('span');
    badge.className = 'badge bg-primary me-1';
    badge.textContent = updateSelectedTag.name;
    badge.setAttribute('data-tag-id', updateSelectedTag.id);
    badge.style.cursor = 'pointer';
    badge.addEventListener('click', function () {
      this.remove();
      updateUpdateTagsInput();
    });
    container.appendChild(badge);
    updateUpdateTagsInput();
  });

  // Update the hidden input with the selected tags for Update Modal and check for changes
  function updateUpdateTagsInput() {
    let tags = [];
    document.querySelectorAll('#updateSelectedTagsContainer span').forEach(badge => {
      tags.push(badge.getAttribute('data-tag-id'));
    });
    document.getElementById('updateSelectedTagsInput').value = tags.join(',');
    checkUpdateChanges();
  }
</script>
{% endblock %}